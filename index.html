<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>„Å®„Åç„ÇÅ„ÅçÁî≤ÊÆª„É°„É¢„É™„Ç¢„É´ HC</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    :root {
      --box-color: rgba(0, 0, 80, 0.9);
      --accent: #ffeb3b;
      --bad-color: #b71c1c;
    }

    body {
      margin: 0;
      background: #222;
      height: 100dvh;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      font-family: 'DotGothic16', sans-serif;
      color: #fff;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    /* === ‚òÖÊñ∞Ë¶èËøΩÂä†: „É≠„Éº„Éá„Ç£„É≥„Ç∞ÁîªÈù¢ === */
    #loading-screen {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: #000;
      z-index: 9999; /* ‰ªñ„ÅÆÂÖ®„Å¶„ÅÆË¶ÅÁ¥†„Çà„ÇäÊâãÂâç„Å´ */
      display: flex; justify-content: center; align-items: center;
      transition: opacity 0.8s ease-out; /* „Éï„Çß„Éº„Éâ„Ç¢„Ç¶„ÉàÂäπÊûú */
    }
    .loading-text {
      font-family: 'Press Start 2P', sans-serif;
      color: var(--accent);
      font-size: clamp(1.5rem, 4vw, 2.5rem); /* ÁîªÈù¢„Çµ„Ç§„Ç∫„Å´Âêà„Çè„Åõ„Å¶Ë™øÊï¥ */
      text-shadow: 2px 2px 0 var(--bad-color);
      animation: blink 0.8s infinite alternate;
    }
    /* Ë™≠„ÅøËæº„ÅøÂÆå‰∫ÜÂæå„Å´ÈÅ©Áî®„Åó„Å¶Èö†„Åô„ÇØ„É©„Çπ */
    .loaded {
      opacity: 0;
      pointer-events: none; /* „ÇØ„É™„ÉÉ„ÇØÁ≠â„ÇíÂèó„Åë‰ªò„Åë„Å™„Åè„Åô„Çã */
    }

    #screen-container {
      position: relative;
      width: 100%;
      max-width: 800px;
      aspect-ratio: 4 / 3;
      background: #000;
      border-radius: 4px;
      box-shadow: 0 0 0 10px #111;
      overflow: hidden;
    }

    @media (max-width: 600px) {
      body { background: #000; }
      #screen-container {
        max-width: 100%; height: 100dvh; aspect-ratio: auto; border-radius: 0; box-shadow: none;
      }

      #title-screen {
        background-size: contain !important;
        background-repeat: no-repeat !important;
        background-color: #000 !important;
      }

      #character-area { bottom: 210px !important; height: 55% !important; }
      #message-box { height: 200px !important; padding: 15px !important; }
      #text-content { font-size: 1.1rem !important; }
      .choice-btn { width: 95% !important; padding: 15px !important; font-size: 1rem !important; }
      #combo-indicator { top: 10px !important; right: 10px !important; font-size: 1rem !important; }
    }

    .screen-layer {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      display: flex; flex-direction: column; transition: opacity 0.5s;
    }
    .hidden { opacity: 0; pointer-events: none; z-index: 0; }
    .active { opacity: 1; z-index: 5; }

    #game-screen {
      background-color: #000; background-size: cover; background-position: center;
      justify-content: flex-end; image-rendering: pixelated; 
    }
    .bg-school    { background-image: url('school_dusk.png'); }
    .bg-rooftop   { background-image: url('rooftop.png'); }
    .bg-corridor  { background-image: url('corridor.png'); }
    .bg-classroom { background-image: url('classroom_dark.png'); }

    #character-area {
      position: absolute; bottom: 180px; left: 50%; transform: translateX(-50%);
      height: 65%; width: auto; pointer-events: none;
      display: flex; align-items: flex-end; justify-content: center;
    }
    #char-img {
      height: 100%; width: auto; display: none; transition: transform 0.2s;
    }

    .angry_anim { animation: shake_char 0.2s infinite; }
    .shy_anim   { }
    .molted_anim { }

    #message-box {
      position: relative; width: 94%; height: 180px;
      background: var(--box-color); border: 4px solid #fff; border-radius: 8px;
      margin-bottom: 20px; padding: 20px; box-sizing: border-box;
      display: flex; flex-direction: column; align-self: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    }
    #name-label {
      color: var(--accent); font-size: 1.3rem; font-weight: bold; margin-bottom: 10px;
      text-shadow: 2px 2px 0 #000; background: rgba(0,0,0,0.3);
      display: inline-block; padding: 2px 10px; border-radius: 4px; align-self: flex-start;
    }
    #text-content { font-size: 1.2rem; line-height: 1.6; flex: 1; white-space: pre-wrap; }
    .next-indicator {
      position: absolute; bottom: 15px; right: 20px; 
      color: var(--accent); font-size: 1.5rem; animation: blink 1s infinite; display: none;
    }

    #choices-container {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); display: none;
      flex-direction: column; justify-content: center; align-items: center; gap: 20px; z-index: 20;
    }
    .choice-btn {
      background: #000; border: 2px solid var(--accent); color: var(--accent);
      padding: 18px 30px; font-size: 1.1rem; font-family: 'DotGothic16';
      cursor: pointer; width: 85%; max-width: 600px; transition: transform 0.1s;
    }
    .choice-btn:hover { background: var(--accent); color: #000; transform: translate(-2px, -2px); }

    #title-screen {
      background-image: url('title_screen.png');
      background-size: cover; background-position: center; image-rendering: pixelated;
      display: flex; justify-content: center; align-items: flex-end; padding-bottom: 60px;
    }

    #start-btn {
      font-family: 'Press Start 2P'; font-size: 1.5rem; cursor: pointer; color: #fff;
      text-shadow: 2px 2px 0 #000, -2px 2px 0 #000, 2px -2px 0 #000, -2px -2px 0 #000;
      animation: blink 1.5s step-end infinite;
      background: rgba(0,0,0,0.5); padding: 10px 20px; border-radius: 4px;
    }
    #start-btn:hover { color: var(--accent); background: rgba(0,0,0,0.7); }

    /* „Çπ„Çø„ÉÉ„Éï„É≠„Éº„É´ÁîªÈù¢ */
    #credit-screen {
      background: #000;
      justify-content: center; align-items: center; overflow: hidden;
    }
    #credit-content {
      position: absolute; top: 100%; width: 100%; text-align: center; padding-bottom: 50px;
    }
    .role { color: var(--accent); font-size: 0.9rem; margin-top: 30px; margin-bottom: 5px; font-family: 'Press Start 2P'; }
    .staff { font-size: 1.2rem; margin-bottom: 20px; }
    .end-msg { font-size: 2rem; margin-top: 60px; color: var(--accent); }
    .click-skip { 
        position: absolute; bottom: 10px; right: 10px; font-size: 0.8rem; color: #555; 
        z-index: 10; animation: blink 2s infinite; 
    }
    .roll-animation { animation: credit-scroll 15s linear forwards; }
    @keyframes credit-scroll { 0% { top: 100%; } 100% { top: -120%; } }

    #combo-indicator {
      position: absolute; top: 20px; right: 20px;
      font-family: 'Press Start 2P'; 
      font-size: 1.2rem; color: #fff;
      text-shadow: 2px 2px 0 #000, -2px 2px 0 #000, 2px -2px 0 #000, -2px -2px 0 #000;
      pointer-events: none; z-index: 10;
    }

    /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
    @keyframes shake_char { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } 100% { transform: translateX(0); } }
    @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }
    .shake_screen { animation: shake_screen_kf 0.4s; }
    @keyframes shake_screen_kf { 0%, 100% { transform: translate(0, 0); } 25% { transform: translate(-10px, 10px); } 75% { transform: translate(10px, -10px); } }
    .flash_red::after { content: ""; position: absolute; top:0; left:0; width:100%; height:100%; background: red; opacity: 0; animation: flash 0.3s; pointer-events: none; }
    @keyframes flash { 0% { opacity: 0.5; } 100% { opacity: 0; } }
  </style>
</head>
<body>

<div id="loading-screen">
  <div class="loading-text">NOW LOADING...ü¶Ä</div>
</div>

<div id="screen-container">
  <div id="title-screen" class="screen-layer active">
    <div id="start-btn">PRESS START</div>
  </div>

  <div id="game-screen" class="screen-layer hidden">
    <div id="combo-indicator">LOVE: <span id="combo-count">0</span>/5</div>
    <div id="character-area">
      <img id="char-img" src="" alt="character">
    </div>
    <div id="message-box">
      <div id="name-label"></div>
      <div id="text-content"></div>
      <div class="next-indicator">‚ñº</div>
    </div>
    <div id="choices-container"></div>
  </div>

  <div id="credit-screen" class="screen-layer hidden">
      <div class="click-skip">CLICK TO SKIP</div>
      <div id="credit-content">
          <div class="role">TITLE</div>
          <div class="staff">„Å®„Åç„ÇÅ„ÅçÁî≤ÊÆª„É°„É¢„É™„Ç¢„É´</div>
          <div class="role">CAST</div>
          <div class="staff">ËüπÂ¥é „Ç´„ÉãÂ≠ê</div>
          <div class="staff">‰∏ª‰∫∫ÂÖ¨ (You)</div>
          <div class="role">SCENARIO & PROGRAM</div>
          <div class="staff">Gemini</div>
          <div class="role">GRAPHICS & SOUND</div>
          <div class="staff">AI Generated Assets</div>
          <div class="role">PRODUCED BY</div>
          <div class="staff">KANI PRO.</div>
          <div class="end-msg">THANK YOU FOR PLAYING!</div>
      </div>
  </div>
</div>

<audio id="bgm_daily" loop preload="auto" src="bgm_daily.mp3"></audio>
<audio id="bgm_emotional" loop preload="auto" src="bgm_emotional.mp3"></audio>

<script>
(() => {
  // ====== „Çµ„Ç¶„É≥„ÉâÁÆ°ÁêÜ ======
  const audioEls = {
      bgm_daily: document.getElementById('bgm_daily'),
      bgm_emotional: document.getElementById('bgm_emotional')
  };
  const seFiles = {
      select: "se_select.mp3",
      bad: "se_bad.mp3"
  };
  let currentBgm = null;

  function playBgm(bgmId) {
      const newBgm = audioEls[bgmId];
      if (!newBgm) return;
      if (currentBgm === newBgm && !newBgm.paused) return; 

      stopBgm();
      currentBgm = newBgm;
      currentBgm.volume = 0.4; 
      currentBgm.currentTime = 0;
      currentBgm.play().catch(e => console.log("BGMÂÜçÁîü„Ç®„É©„Éº:", e));
  }

  function stopBgm() {
      if (currentBgm) {
          currentBgm.pause();
          currentBgm = null;
      }
  }

  function playSe(seName) {
      if (!seFiles[seName]) return;
      const se = new Audio(seFiles[seName]);
      se.volume = 0.6;
      se.play().catch(e => console.log("SEÂÜçÁîü„Ç®„É©„Éº:", e));
  }

  // ====== „Ç∑„Éä„É™„Ç™„Éá„Éº„Çø ======
  const SCENARIO = {
    "scene1_start": {
      bgClass: "bg-school",
      bgm: "bgm_daily", 
      text: "ÔºàËª¢Ê†°ÂàùÊó•„ÄÅÊÖ£„Çå„Å™„ÅÑÊ†°Ëàé„ÅßËø∑„Å£„Å¶„Åó„Åæ„Å£„Åü„ÄÇ„ÇÇ„ÅÜ„Åô„Å£„Åã„ÇäÂ§ïÊöÆ„Çå„Å†‚Ä¶Ôºâ",
      name: "‰∏ª‰∫∫ÂÖ¨",
      img: null, 
      next: "scene1_impact"
    },
    "scene1_impact": {
      text: "„Éâ„Ç´„ÉÉÔºÅ\n„Äå„ÅÜ„Çè„Å£ÔºÅ„Äç",
      name: "‰∏ª‰∫∫ÂÖ¨",
      effect: "shake_screen",
      next: "scene1_meet"
    },
    "scene1_meet": {
      text: "„Äå„Åç„ÇÉ„Å£ÔºÅ ‚Ä¶„ÅÑ„Å£„ÄÅÁóõ„ÅÑ‚Ä¶„Äç",
      name: "???",
      img: "kani_surprise.png", 
      emotion: "shy_anim",
      next: "scene1_monologue"
    },
    "scene1_monologue": {
      text: "ÔºàÂ•≥„ÅÆÂ≠ê„Å®„Å∂„Å§„Åã„Å£„Å¶„Åó„Åæ„Å£„Åü„ÄÇ„Çà„ÅèË¶ã„Çã„Å®ÂΩºÂ•≥„ÄÅÈ†≠„Å´‚Ä¶„Ç´„Éã„ÅÆ„Éè„Çµ„Éü„Åå„Å§„ÅÑ„Å¶„ÇãÔºÅÔºüÔºâ",
      name: "‰∏ª‰∫∫ÂÖ¨",
      next: "scene1_angry"
    },
    "scene1_angry": {
      text: "„Äå„Å°„Çá„Å£„Å®„Ç¢„É≥„ÇøÔºÅ „Å©„ÅìË¶ã„Å¶Ê≠©„ÅÑ„Å¶„Çì„ÅÆ„ÇàÔºÅ „Ç¢„Çø„Ç∑„ÅÆËá™ÊÖ¢„ÅÆ„Éè„Çµ„Éü„Å´ÂÇ∑„Åå„Å§„ÅÑ„Åü„Çâ„Å©„ÅÜ„Åô„Çì„ÅÆÔºÅÔºü„Äç",
      name: "ËüπÂ¥é„Ç´„ÉãÂ≠ê",
      img: "kani_angry.png",
      emotion: "angry_anim",
      next: "q1_choice"
    },
    "q1_choice": {
      choices: [
        { label: "„Åî„ÇÅ„ÇìÔºÅÂ§ß‰∏àÂ§´Ôºü", next: "q1_fail", correct: false },
        { label: "„Åù„ÅÆ„Éè„Çµ„Éü„ÄÅÂáÑ„ÅèÁ´ãÊ¥æ„Å†„Å≠ÔºÅ", next: "q1_success", correct: true },
        { label: "ÁæéÂë≥„Åó„Åù„ÅÜ„Å™ÂåÇ„ÅÑ„Åå„Åô„Çã‚Ä¶", next: "q1_fail", correct: false }
      ]
    },
    "q1_fail": {
      text: "„Äå„Éï„É≥„ÄÅ„Ç¢„Çø„Ç∑Âøô„Åó„ÅÑ„Åã„Çâ„ÄÇ„Äç\nÔºàÂΩºÂ•≥„ÅØ‰∏çÊ©üÂ´å„Åù„ÅÜ„Å†‚Ä¶Ôºâ",
      name: "„Ç´„ÉãÂ≠ê",
      img: "kani_angry.png",
      next: "scene2_start"
    },
    "q1_success": {
      text: "„Äå„Åà„Å£‚Ä¶„Åù„ÄÅ„Åù„ÅÜÔºü ÂàÜ„Åã„Çã„ÅÆÔºü ‚Ä¶„Åæ„ÄÅ„Åæ„ÅÇ„Å≠„ÄÇ‰ºäÈÅî„Å´ÊØéÊó•Á£®„ÅÑ„Å¶„Å™„ÅÑ„Çè„Çà„Äç",
      name: "„Ç´„ÉãÂ≠ê",
      img: "kani_shy.png",
      emotion: "shy_anim",
      next: "scene2_start"
    },
    // --- Scene 2 ---
    "scene2_start": {
      bgClass: "bg-rooftop",
      bgm: "bgm_daily",
      text: "ÔºàÁøåÊó•„ÅÆÊòº‰ºë„Åø„ÄÇÂ±ã‰∏ä„Å´Êù•„Å¶„Åø„Çã„Å®„ÄÅÂΩºÂ•≥„Åå‰∏Ä‰∫∫„Åß„ÅÑ„Åü„ÄÇÂÖÉÊ∞ó„Åå„Å™„Åï„Åù„ÅÜ„Å†Ôºâ",
      name: "‰∏ª‰∫∫ÂÖ¨",
      img: "kani_sad.png",
      next: "scene2_talk"
    },
    "scene2_talk": {
      text: "„Äå‚Ä¶Âà•„Å´„ÄÇ‚Ä¶Âòò„ÄÇ„Å°„Çá„Å£„Å®„ÄÅÊó•Â∑Æ„Åó„ÅåÂº∑„Åô„Åé„Å¶‚Ä¶„Äç",
      name: "„Ç´„ÉãÂ≠ê",
      img: "kani_sad.png", 
      next: "q2_choice"
    },
    "q2_choice": {
      choices: [
        { label: "„Çπ„Éù„Éº„ÉÑ„Éâ„É™„É≥„ÇØÈ£≤„ÇÄÔºü", next: "q2_fail", correct: false },
        { label: "ÔºàÁÑ°Ë®Ä„ÅßÈúßÂêπ„Åç„Çí„Åã„Åë„ÇãÔºâ", next: "q2_success", correct: true },
        { label: "Êó•ÂÇò„Çí„Åï„Åó„Å¶„ÅÇ„Åí„Çã", next: "q2_fail", correct: false }
      ]
    },
    "q2_fail": {
      text: "„Äå„Åù„Çì„Å™„ÅÆ„ÅÑ„Çâ„Å™„ÅÑ„Çè„Çà‚Ä¶„ÅØ„ÅÅ„ÄÅ‰πæ„Åè‚Ä¶„Äç",
      name: "„Ç´„ÉãÂ≠ê",
      img: "kani_sad.png", 
      next: "scene_search_start"
    },
    "q2_success": {
      text: "„Ç∑„É•„ÉÉ„Ç∑„É•„ÉÉ‚Ä¶\n„ÄåÔºÅÔºü ‚Ä¶„Å™„ÄÅ‰Ωï„Çà„Ç§„Ç≠„Éä„É™ÔºÅ ‚Ä¶‚Ä¶„Åß„ÇÇ„ÄÅ„Å°„Çá„Å£„Å®‚Ä¶ÊΩ§„Å£„Åü„Åã„ÇÇ„ÄÇ‚Ä¶„ÅÇ„Çä„Åå„Å®„Äç",
      name: "„Ç´„ÉãÂ≠ê",
      img: "kani_shy.png",
      emotion: "shy_anim",
      next: "scene_search_start"
    },
    // --- Scene 3 (‰ºöË©±) ---
    "scene_search_start": {
      bgClass: "bg-corridor",
      bgm: "bgm_daily",
      text: "ÔºàÊîæË™≤Âæå„ÄÇÂΩºÂ•≥„ÅÆÂßø„ÇíÊé¢„Åó„Å¶Âªä‰∏ã„ÇíÊ≠©„ÅÑ„Å¶„ÅÑ„Çã„Å®„ÄÅÂâçÊñπ„Å´ÂΩºÂ•≥„ÅÆÂßø„ÇíË¶ã„Å§„Åë„ÅüÔºâ\n„Äå„ÅÇ„ÄÅ„Ç´„ÉãÂ≠ê„Åï„ÇìÔºÅ„Äç",
      name: "‰∏ª‰∫∫ÂÖ¨",
      img: null,
      next: "scene_hallway_talk1"
    },
    "scene_hallway_talk1": {
      text: "„Äå‚Ä¶ÔºÅ „Å™„Å´„Çà„ÄÅ„Åæ„Åü„Ç¢„É≥„ÇøÔºü„Äç\nÔºàÂ£∞„Çí„Åã„Åë„Çã„Å®„ÄÅÂΩºÂ•≥„ÅØ„Éì„ÇØ„ÉÉ„Å®„Åó„Å¶ÊåØ„ÇäËøî„Å£„Åü„ÄÇÂ∞ë„ÅóË≠¶Êàí„Åó„Å¶„ÅÑ„Çã„Çà„ÅÜ„Å†Ôºâ",
      name: "„Ç´„ÉãÂ≠ê",
      img: "kani_normal.png",
      emotion: "shy_anim", 
      next: "scene_hallway_talk2"
    },
    "scene_hallway_talk2": {
      text: "„Äå„ÅÑ„ÇÑ„ÄÅÊòº‰ºë„Åø„ÄÅÂÖÉÊ∞ó„Å™„Åï„Åù„ÅÜ„Å†„Å£„Åü„Åã„ÇâÊ∞ó„Å´„Å™„Å£„Å¶‚Ä¶„Äç\n„Äå‚Ä¶Âà•„Å´„ÄÇ„Åª„Å£„Å®„ÅÑ„Å¶„Çà„ÄÇ„Äç\nÔºà„Åù„ÅÜË®Ä„Å£„Å¶Á´ã„Å°Âéª„Çç„ÅÜ„Å®„Åô„Çã„Åå„ÄÅË∂≥Âèñ„Çä„ÅåÂ∞ë„Åó„Åµ„Çâ„Å§„ÅÑ„Å¶„ÅÑ„ÇãÔºâ",
      name: "„Ç´„ÉãÂ≠ê&‰∏ª‰∫∫ÂÖ¨",
      img: "kani_sad.png",
      next: "q3_choice" 
    },
    // --- Q3 ---
    "q3_choice": {
      choices: [
        { label: "„ÄåÈ°îËâ≤„ÅåÊÇ™„ÅÑ„Çà„ÄÅ‰øùÂÅ•ÂÆ§Ë°å„Åì„ÅÜ„Äç", next: "q3_talk_fail", correct: false },
        { label: "„Äå‚Ä¶‰Ωï„Åã„ÄÅÂÉï„Å´„Åß„Åç„Çã„Åì„Å®„ÅØ„Å™„ÅÑÔºü„Äç", next: "q3_talk_success", correct: true },
        { label: "Èªô„Å£„Å¶Âæå„Çí„Å§„Åë„Çã", next: "q3_talk_stalk", correct: false }
      ]
    },
    "q3_talk_fail": {
      text: "„Äå„ÅÜ„Çã„Åï„ÅÑ„Å™„ÅÅ‚Ä¶„ÄÇÂπ≥Ê∞ó„Å†„Å£„Å¶Ë®Ä„Å£„Å¶„Çã„Åß„Åó„Çá„ÄÇ„Å§„ÅÑ„Å¶„Åì„Å™„ÅÑ„Åß„ÇàÔºÅ„Äç\nÔºàÂº∑„ÅèÊãíÁµ∂„Åï„Çå„Å¶„Åó„Åæ„Å£„Åü‚Ä¶ÂΩºÂ•≥„ÅØËµ∞„ÇäÂéª„Å£„Å¶„Åó„Åæ„Å£„ÅüÔºâ",
      name: "„Ç´„ÉãÂ≠ê",
      img: "kani_angry.png",
      emotion: "angry_anim",
      next: "scene_hallway_to_old_school_fail"
    },
    "q3_talk_stalk": {
      text: "Ôºà‚Ä¶ÂøÉÈÖç„Å†„ÄÇ„Éê„É¨„Å™„ÅÑ„Çà„ÅÜ„Å´„Åù„Å£„Å®Âæå„Çí„Å§„Åë„Çà„ÅÜÔºâ\n‚Ä¶‚Ä¶\nÔºàË¶ãÂ§±„Å£„Å¶„Åó„Åæ„Å£„Åü‚Ä¶Â§öÂàÜ„ÄÅ„ÅÇ„Å£„Å°„ÅÆÊñπËßí„Å†„Åë„Å©‚Ä¶Ôºâ",
      name: "‰∏ª‰∫∫ÂÖ¨",
      img: null,
      next: "scene_hallway_to_old_school_fail"
    },
    "q3_talk_success": {
      text: "„Äå‚Ä¶„ÅàÔºü„Äç\nÔºà‰∫àÊÉ≥Â§ñ„ÅÆË®ÄËëâ„Å†„Å£„Åü„ÅÆ„Åã„ÄÅÂΩºÂ•≥„ÅØÂ∞ë„ÅóË∂≥„ÇíÊ≠¢„ÇÅ„ÅüÔºâ\n„Äå‚Ä¶„Ç¢„É≥„Çø„Å´„ÄÅ„Åß„Åç„Çã„Åì„Å®„Å™„Çì„Å¶‚Ä¶„Äç",
      name: "„Ç´„ÉãÂ≠ê",
      img: "kani_shy.png",
      next: "q3_talk_success2"
    },
    "q3_talk_success2": {
      text: "„Äå‚Ä¶„ÅØ„ÅÅ„ÄÇ„ÅÑ„ÅÑ„Çè„Çà„ÄÅÂãùÊâã„Å´„Åó„Å¶„ÄÇ‚Ä¶„Ç¢„Çø„Ç∑„ÅØ„ÄÅÈùô„Åã„Å™„Å®„Åì„Çç„Å´Ë°å„Åç„Åü„ÅÑ„Å†„Åë„Å†„Åã„Çâ„Äç\nÔºàÂΩºÂ•≥„ÅØ„Åù„ÅÜÂëü„Åè„Å®„ÄÅÊóßÊ†°Ëàé„ÅÆÊñπ„Å∏„Å®Ê≠©„ÅçÂá∫„Åó„Åü„ÄÇ„Å§„ÅÑ„Å¶„ÅÑ„Å£„Å¶„ÇÇËâØ„Åï„Åù„ÅÜ„Å†Ôºâ",
      name: "„Ç´„ÉãÂ≠ê",
      img: "kani_sad.png",
      next: "scene3_start_following" 
    },
    "scene_hallway_to_old_school_fail": {
      text: "ÔºàÂΩºÂ•≥„ÅåÂêë„Åã„Å£„Åü„ÅÆ„ÅØ„ÄÅ„Åä„Åù„Çâ„Åè‰∫∫Ê∞ó„ÅÆ„Å™„ÅÑÊóßÊ†°Ëàé„ÅÆÊñπ„Å†„ÄÇÈÅÖ„Çå„Å¶„Åó„Åæ„Å£„Åü„Åë„Å©„ÄÅË°å„Å£„Å¶„Åø„Çà„ÅÜÔºâ",
      name: "‰∏ª‰∫∫ÂÖ¨",
      img: null,
      next: "scene3_start"
    },
    // --- Scene 4 (ÊóßÊ†°Ëàé) ---
    "scene3_start_following": {
      bgClass: "bg-classroom",
      bgm: "bgm_emotional", 
      text: "ÔºàÂΩºÂ•≥„ÅÆÂæå„Çí„Å§„ÅÑ„Å¶„ÅÑ„Åç„ÄÅÊóßÊ†°Ëàé„ÅÆÊïôÂÆ§„ÅÆÂâç„Åæ„ÅßÊù•„Åü„ÄÇÂΩºÂ•≥„ÅØÂÖà„Å´‰∏≠„Å´ÂÖ•„Çä„ÄÅ„Éâ„Ç¢„ÇíÈñâ„ÇÅ„Åü„ÄÇ‰∏≠„Åã„ÇâÁâ©Èü≥„Åå„Åô„Çã‚Ä¶Ôºâ",
      name: "‰∏ª‰∫∫ÂÖ¨",
      img: null,
      next: "q4_choice"
    },
    "scene3_start": {
      bgClass: "bg-classroom",
      bgm: "bgm_emotional", 
      text: "Ôºà„Å™„Çì„Å®„ÅãË¶ãÂ§±„Çè„Åö„Å´Ê∏à„Çì„Å†„ÄÇÂΩºÂ•≥„ÅåÂÖ•„Å£„Å¶„ÅÑ„Å£„ÅüÊóßÊ†°Ëàé„ÅÆÊïôÂÆ§„ÅÆÂâç„Å´ÁùÄ„ÅÑ„Åü„ÄÇ‰∏≠„Åã„Çâ„Ç¨„Çµ„Ç¥„ÇΩ„Å®Áâ©Èü≥„Åå„Åô„Çã‚Ä¶Ôºâ",
      name: "‰∏ª‰∫∫ÂÖ¨",
      img: null,
      next: "q4_choice"
    },
    "q4_choice": {
      choices: [
        { label: "„Äå„Ç´„ÉãÂ≠ê„Åï„Çì„ÄÅ„ÅÑ„Çã„ÅÆÔºü„Äç„Å®„Éé„ÉÉ„ÇØ", next: "q4_success", correct: true },
        { label: "Âã¢„ÅÑ„Çà„Åè„Éâ„Ç¢„ÇíÈñã„Åë„ÇãÔºÅ", next: "q4_fail_barge", correct: false },
        { label: "ÈöôÈñì„Åã„Çâ‰∏≠„ÇíË¶ó„Åè", next: "q4_fail_peek", correct: false }
      ]
    },
    "q4_fail_barge": {
      text: "„Éê„É≥„ÉÉÔºÅ\n„Äå„Ç≠„É£„Ç¢„Ç¢„Ç¢ÔºÅÔºÅ Ë¶ã„Å™„ÅÑ„Åß„Çà„Éê„Ç´ÔºÅÔºÅ„Äç",
      name: "„Ç´„ÉãÂ≠ê",
      img: "kani_angry.png",
      effect: "shake_screen",
      next: "scene3_talk_entry"
    },
    "q4_fail_peek": {
      text: "Ôºà‚Ä¶ÁõÆ„ÅåÂêà„Å£„ÅüÊ∞ó„Åå„Åô„ÇãÔºâ\n„Äå‰ªä‚Ä¶Ë¶ã„Åü„Çè„Å≠‚Ä¶Ôºü„Äç",
      name: "„Ç´„ÉãÂ≠ê",
      img: "kani_angry.png",
      effect: "flash_red",
      next: "scene3_talk_entry"
    },
    "q4_success": {
      text: "„Ç≥„É≥„Ç≥„É≥„ÄÇ\n„Äå‚Ä¶„Å£ÔºÅÔºü Ë™∞‚Ä¶Ôºü ÂÖ•„Å£„Å¶„Åì„Å™„ÅÑ„ÅßÔºÅ„Äç",
      name: "„Ç´„ÉãÂ≠ê",
      next: "scene3_talk_entry"
    },
    "scene3_talk_entry": {
      text: "ÔºàÊïôÂÆ§„ÅÆÈöÖ„Åß„ÄÅÂΩºÂ•≥„ÅåÈúá„Åà„Å¶„ÅÑ„ÇãÔºâ",
      name: "‰∏ª‰∫∫ÂÖ¨",
      img: "kani_sad.png",
      next: "scene3_talk2"
    },
    "scene3_talk2": {
      text: "„ÄåÈÅï„ÅÜ„ÅÆ‚Ä¶‰ªä„ÄÅ„Ç¢„Çø„Ç∑‚Ä¶„ÄéËÑ±ÁöÆ„Äè„ÅåËøë„Åè„Å¶‚Ä¶„ÄÇÁî≤ÁæÖ„ÅåÊµÆ„ÅÑ„Å¶„Åç„Å¶‚Ä¶„Åô„Åî„Åè„ÄÅÊÉÖÁ∑í‰∏çÂÆâÂÆö„Å™„ÅÆ‚Ä¶„Äç",
      name: "„Ç´„ÉãÂ≠ê",
      img: "kani_sad.png",
      emotion: "angry_anim",
      next: "scene3_talk3"
    },
    "scene3_talk3": {
      text: "„Äå„ÅäÈ°ò„ÅÑ„ÄÅ„ÅÇ„Å£„Å°Ë°å„Å£„Å¶ÔºÅ ‰ªä„ÅÆ„Ç¢„Çø„Ç∑„ÄÅË™∞„Å´„ÇÇË¶ã„Çâ„Çå„Åü„Åè„Å™„ÅÑ„ÅÆ‚Ä¶ÔºÅ„Äç",
      name: "„Ç´„ÉãÂ≠ê",
      img: "kani_normal.png",
      next: "q5_choice"
    },
    "q5_choice": {
      choices: [
        { label: "„ÄåÂ§ß‰∏àÂ§´„Å†„ÇàÔºÅ„Äç„Å®Êä±„Åç„Åó„ÇÅ„Çã", next: "scene3_hug_reject", correct: false },
        { label: "„Äå„Çè„Åã„Å£„Åü„ÄÇÂ§ñ„ÅßË¶ãÂºµ„Å£„Å¶„Çã„Çà„Äç", next: "check_judgment", correct: true }
      ]
    },
    "scene3_hug_reject": {
      text: "„Äå„Å≤„ÇÉ„ÅÇ„Å£ÔºÅÔºü ‚Ä¶„ÇÑ„ÄÅ„ÇÑ„ÇÅ„Å¶ÔºÅ „Åï„Çè„Çâ„Å™„ÅÑ„Åß„ÇàÔºÅÔºÅ„Äç\nÔºàÂΩºÂ•≥„ÅØ„Éë„Éã„ÉÉ„ÇØ„Å´„Å™„Çä„ÄÅÂÉï„ÇíÂº∑„ÅèÁ™Å„ÅçÈ£õ„Å∞„Åó„ÅüÔºâ",
      name: "„Ç´„ÉãÂ≠ê",
      img: "kani_angry.png",
      emotion: "angry_anim",
      effect: "shake_screen",
      next: "check_judgment"
    },

    // ‚òÖÈÅãÂëΩÂà§ÂÆö„Éù„Ç§„É≥„Éà‚òÖ
    "check_judgment": { }, 

    // --- BAD END ---
    "bad_end_3": {
      text: "‚Ä¶Êï∞Êó•Âæå„ÄÇÂΩºÂ•≥„ÅåÂ≠¶Ê†°„Å´Êù•„Çã„Åì„Å®„ÅØ‰∫åÂ∫¶„Å®„Å™„Åã„Å£„Åü„ÄÇ\nÈ¢®„ÅÆÂôÇ„Åß„ÄÅËøë„Åè„ÅÆÊºÅÊ∏Ø„Åß„ÄåÁèç„Åó„ÅÑ„Ç´„Éã„Äç„ÅåÊ∞¥Êèö„Åí„Åï„Çå„Åü„Å®ËÅû„ÅÑ„Åü„ÄÇ",
      name: "‰∏ª‰∫∫ÂÖ¨",
      img: null, 
      next: "bad_end_4"
    },
    "bad_end_4": {
      bgm: "bgm_emotional",
      text: "„Åù„ÅÆÊó•„ÅÆÊô©Âæ°È£Ø„Å´Âá∫„Å¶„Åç„Åü„Ç´„ÉãÈçã„ÅØ„ÄÅ„Å™„Åú„Å†„Åã„ÄÅ„Å®„Å¶„ÇÇÊÇ≤„Åó„ÅÑÂë≥„Åå„Åó„Åü„ÄÇ\n\n„Äê BAD END - Ê•µ‰∏ä„ÅÆÂá∫Ê±Å - „Äë",
      name: "",
      next: "ending_credits"
    },

    // --- GOOD END ---
    "good_end_start": {
      text: "ÂÉï„ÅØÊââ„ÅÆÂ§ñ„Åß„ÄÅ„Åò„Å£„Å®ÂæÖ„Å°Á∂ö„Åë„Åü„ÄÇ\nÊï∞ÊôÇÈñìÂæå„ÄÅÊïôÂÆ§„ÅÆ‰∏≠„Åã„ÇâÁâ©Èü≥„Åå„Åó„Åü„ÄÇ",
      name: "‰∏ª‰∫∫ÂÖ¨",
      img: null,
      next: "good_end_2"
    },
    "good_end_2": {
      bgm: "bgm_daily", 
      text: "„Äå‚Ä¶„ÇÇ„ÅÜ„ÄÅÂÖ•„Å£„Å¶„ÅÑ„ÅÑ„Çè„Çà„Äç\nÊïôÂÆ§„Å´ÂÖ•„Çã„Å®„ÄÅ„Åù„Åì„Å´„ÅØÂ∞ë„ÅóÈõ∞Âõ≤Ê∞ó„ÅåÂ§â„Çè„Å£„ÅüÂΩºÂ•≥„Åå„ÅÑ„Åü„ÄÇ",
      name: "„Ç´„ÉãÂ≠ê",
      img: "kani_molted.png",
      emotion: "molted_anim",
      next: "good_end_3"
    },
    "good_end_3": {
      text: "„Äå‚Ä¶„Ç¢„É≥„Çø„ÄÅÊú¨ÂΩì„Å´„Éê„Ç´Ê≠£Áõ¥„Å´ÂæÖ„Å£„Å¶„Åü„ÅÆ„Å≠„ÄÇ\nÊ≠£Áõ¥„ÄÅ‰ªä„Åæ„Åß„ÅÆË°åÂãï„ÇíË¶ã„Å¶„Å¶‚Ä¶„Ç¢„É≥„Çø„Å™„Çâ‰ø°„Åò„Çâ„Çå„Çã„Åã„ÇÇ„Å£„Å¶„ÄÅÊÄù„Å£„Å¶„Åü„Äç",
      name: "„Ç´„ÉãÂ≠ê",
      img: "kani_molted.png", 
      next: "good_end_4"
    },
    "good_end_4": {
      text: "„Äå‚Ä¶‚Ä¶‚Ä¶„Éï„É≥„ÄÇ„Ç¢„É≥„Çø„ÅÆÂâç„Åß„Å†„Åë„ÅØ„ÄÅ„Åì„ÅÆÊñ∞„Åó„ÅÑÁî≤ÁæÖ‚Ä¶Â∞ë„Åó„Å†„Åë„ÄÅÊüî„Çâ„Åã„Åè„Åó„Å®„ÅÑ„Å¶„ÅÇ„Åí„Å¶„ÇÇ„ÅÑ„ÅÑ„Çè„Çà„Äç",
      name: "„Ç´„ÉãÂ≠ê",
      img: "kani_molted.png",
      emotion: "shy_anim",
      next: "good_end_5"
    },
    "good_end_5": {
      text: "ÂÉï„Åü„Å°„ÅÆÂ•áÂ¶ô„Å™Èñ¢‰øÇ„ÅØ„ÄÅËÑ±ÁöÆ„Åó„Åü„Å∞„Åã„Çä„ÅÆÂΩºÂ•≥„ÅÆÂøÉ„ÅÆ„Çà„ÅÜ„Å´„ÄÅ„Åì„Åì„Åã„ÇâÊñ∞„Åó„ÅèÂßã„Åæ„Å£„Å¶„ÅÑ„Åè„ÅÆ„Å†„Çç„ÅÜ„ÄÇ\n\n„Äê GOOD END - Á°¨„ÅÑÁî≤ÁæÖ„Å®Êüî„Çâ„Åã„ÅÑÂøÉ - „Äë",
      name: "‰∏ª‰∫∫ÂÖ¨",
      next: "ending_credits"
    },

    "ending_credits": { special: "credits" },
    "title_return": { text: "", name: "", next: "__TITLE__" }
  };


  // ====== „Ç®„É≥„Ç∏„É≥ÈÉ®ÂàÜ ======
  const els = {
    screenContainer: document.getElementById('screen-container'),
    titleScreen: document.getElementById('title-screen'),
    gameScreen: document.getElementById('game-screen'),
    startBtn: document.getElementById('start-btn'),
    charArea: document.getElementById('character-area'),
    charImg: document.getElementById('char-img'),
    messageBox: document.getElementById('message-box'),
    nameLabel: document.getElementById('name-label'),
    textContent: document.getElementById('text-content'),
    nextIndicator: document.querySelector('.next-indicator'),
    choicesContainer: document.getElementById('choices-container'),
    comboCount: document.getElementById('combo-count'),
    creditScreen: document.getElementById('credit-screen'),
    creditContent: document.getElementById('credit-content'),
    loadingScreen: document.getElementById('loading-screen')
  };

  let currentSceneId = null;
  let isTyping = false;
  let typeTimer;
  let fullText = "";
  let combo = 0;
  let creditTimer = null;

  function init() {
    els.startBtn.addEventListener('click', startGame);
    els.creditScreen.addEventListener('click', () => {
        if(els.creditScreen.classList.contains('active')) returnToTitle();
    });

    // ‚òÖÊñ∞Ë¶èËøΩÂä†: „É≠„Éº„ÉâÂÆå‰∫ÜÊ§úÁü•„Ç§„Éô„É≥„Éà
    // „Åô„Åπ„Å¶„ÅÆ„É™„ÇΩ„Éº„ÇπÔºàÁîªÂÉè„ÄÅÈü≥Â£∞„ÄÅ„Éï„Ç©„É≥„ÉàÁ≠âÔºâ„ÅÆË™≠„ÅøËæº„Åø„ÅåÂÆå‰∫Ü„Åó„Åü„ÇâÂÆüË°å
    window.addEventListener('load', () => {
        // Âøµ„ÅÆ„Åü„ÇÅÂ∞ë„ÅóÂæÖ„Å£„Å¶„Åã„Çâ„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà„Åï„Åõ„ÇãÔºàÊºîÂá∫Ôºâ
        setTimeout(() => {
            if (els.loadingScreen) {
                els.loadingScreen.classList.add('loaded');
            }
        }, 800); // 0.8ÁßíÂæÖÊ©ü
    });
  }

  function startGame() {
    playSe('select'); 

    combo = 0;
    updateCombo();
    els.titleScreen.classList.remove('active');
    els.titleScreen.classList.add('hidden');
    els.gameScreen.classList.remove('hidden');
    els.gameScreen.classList.add('active');
    els.creditScreen.classList.add('hidden');
    els.creditScreen.classList.remove('active');
    loadScene("scene1_start");
  }

  function returnToTitle() {
    stopBgm(); 
    clearTimeout(creditTimer);
    els.gameScreen.classList.remove('active');
    els.gameScreen.classList.add('hidden');
    els.creditScreen.classList.remove('active');
    els.creditScreen.classList.add('hidden');
    els.creditContent.classList.remove('roll-animation');
    els.titleScreen.classList.remove('hidden');
    els.titleScreen.classList.add('active');
    els.gameScreen.className = "screen-layer hidden"; 
  }

  function updateCombo() {
      els.comboCount.textContent = combo;
  }

  function loadScene(id) {
    if (id === "__TITLE__") { returnToTitle(); return; }
    
    // ÈÅãÂëΩÂà§ÂÆö
    if (id === "check_judgment") {
        if (combo >= 5) {
            loadScene("good_end_start");
        } else {
            loadScene("bad_end_3");
        }
        return;
    }

    currentSceneId = id;
    const scene = SCENARIO[id];

    if (scene.special === "credits") { playCredits(); return; }
    if (scene.choices) { showChoices(scene.choices); return; }

    if (scene.bgm) { playBgm(scene.bgm); }

    els.screenContainer.classList.remove('shake_screen');
    els.gameScreen.classList.remove('flash_red');
    if (scene.bgClass) els.gameScreen.className = "screen-layer active " + scene.bgClass;
    if (scene.effect === "shake_screen") {
      els.screenContainer.classList.add('shake_screen');
      setTimeout(() => els.screenContainer.classList.remove('shake_screen'), 500);
    } else if (scene.effect === "flash_red") {
      els.gameScreen.classList.add('flash_red');
    }
    
    updateCharacter(scene);
    els.nameLabel.textContent = scene.name || "";
    els.nextIndicator.style.display = 'none';
    typeText(scene.text);
  }

  function playCredits() {
      playBgm('bgm_daily');

      els.gameScreen.classList.remove('active');
      els.gameScreen.classList.add('hidden');
      els.creditScreen.classList.remove('hidden');
      els.creditScreen.classList.add('active');
      els.creditContent.classList.remove('roll-animation');
      void els.creditContent.offsetWidth;
      els.creditContent.classList.add('roll-animation');
      creditTimer = setTimeout(returnToTitle, 17000);
  }

  function updateCharacter(scene) {
    if (scene.img === null) {
        els.charImg.style.display = 'none'; 
        els.charImg.src = "";
    } else if (scene.img) {
        els.charImg.style.display = 'block'; 
        els.charImg.src = scene.img;
        els.charImg.className = ""; 
        if(scene.emotion) els.charImg.classList.add(scene.emotion);
    }
  }

  function typeText(text) {
    fullText = text; els.textContent.textContent = ""; isTyping = true; let i = 0;
    clearInterval(typeTimer);
    typeTimer = setInterval(() => {
      els.textContent.textContent += text.charAt(i); i++;
      if (i >= text.length) finishTyping();
    }, 40);
  }

  function finishTyping() {
    clearInterval(typeTimer); els.textContent.textContent = fullText; isTyping = false;
    els.nextIndicator.style.display = 'block';
  }

  els.messageBox.addEventListener('click', () => {
    if (isTyping) finishTyping(); else {
      const scene = SCENARIO[currentSceneId];
      if (scene && scene.next && !scene.choices) loadScene(scene.next);
    }
  });

  function showChoices(choices) {
    els.choicesContainer.innerHTML = ""; els.choicesContainer.style.display = "flex";
    choices.forEach(choice => {
      const btn = document.createElement("button"); btn.className = "choice-btn"; btn.textContent = choice.label;
      btn.onclick = (e) => {
        e.stopPropagation();
        if (choice.correct) {
            combo++;
            playSe('select'); 
        } else {
            combo = 0;
            playSe('bad'); 
        }
        updateCombo(); els.choicesContainer.style.display = "none"; loadScene(choice.next);
      };
      els.choicesContainer.appendChild(btn);
    });
  }

  init();
})();
</script>
</body>
</html>
